{% extends "base.html" %}
{% block title %}Admin Dashboard — Beauty Commerce{% endblock %}

{% block head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Full-bleed helper: lets content extend to the viewport edges despite the base container */
    .full-bleed { margin-left: calc(50% - 50vw); margin-right: calc(50% - 50vw); }
    @media (min-width: 1024px) {
      .full-bleed { margin-left: calc(50% - 50vw); margin-right: calc(50% - 50vw); }
    }
  </style>
{% endblock %}

{% block content %}

<div class="full-bleed px-4 md:px-6 lg:px-8">

  <!-- Header -->
  <div class="bg-white/95 backdrop-blur shadow-soft rounded-2xl p-6 border border-emerald-100">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
      <div class="space-y-1">
        <h1 class="text-2xl font-bold text-slate-800">
          {{ (settings.store_name if settings else '') or 'Dashboard' }}
        </h1>
        {% if admin %}
          <p class="text-slate-500">Welcome, {{ admin.name }} • {{ admin.email }}</p>
        {% endif %}
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <a href="{{ url_for('products_new_admin') }}"
           class="inline-flex items-center gap-2 px-4 py-2 rounded-xl font-semibold text-white bg-emerald-600 hover:bg-emerald-700 focus-visible:ring-2 focus-visible:ring-emerald-300 transition">
          <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/></svg>
          Add Product
        </a>
        <a href="{{ url_for('export_orders_csv') }}"
           class="inline-flex items-center gap-2 px-4 py-2 rounded-xl font-semibold bg-white border border-slate-200 hover:bg-slate-50 shadow-sm transition">
          <svg class="w-4 h-4 text-slate-600" viewBox="0 0 20 20" fill="currentColor"><path d="M3 14a2 2 0 002 2h10a2 2 0 002-2v-1a1 1 0 112 0v1a4 4 0 01-4 4H5a4 4 0 01-4-4v-1a1 1 0 112 0v1z"/><path d="M7 9a1 1 0 011-1h2V3a1 1 0 112 0v5h2a1 1 0 01.7 1.714l-3 3a1 1 0 01-1.4 0l-3-3A1 1 0 017 9z"/></svg>
          Export Orders CSV
        </a>
        <a href="{{ url_for('export_products_csv') }}"
           class="inline-flex items-center gap-2 px-4 py-2 rounded-xl font-semibold bg-white border border-slate-200 hover:bg-slate-50 shadow-sm transition">
          <svg class="w-4 h-4 text-slate-600" viewBox="0 0 20 20" fill="currentColor"><path d="M3 14a2 2 0 002 2h10a2 2 0 002-2v-1a1 1 0 112 0v1a4 4 0 01-4 4H5a4 4 0 01-4-4v-1a1 1 0 112 0v1z"/><path d="M7 9a1 1 0 011-1h2V3a1 1 0 112 0v5h2a1 1 0 01.7 1.714l-3 3a1 1 0 01-1.4 0l-3-3A1 1 0 017 9z"/></svg>
          Export Products CSV
        </a>
      </div>
    </div>
  </div>

  <!-- KPI tiles -->
  <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-4 mt-6">
    <div class="group bg-white/95 shadow-soft rounded-2xl p-4 border border-emerald-50 hover:border-emerald-200 transition">
      <div class="flex items-center gap-4">
        <div class="h-12 w-12 rounded-xl bg-emerald-600/10 flex items-center justify-center group-hover:bg-emerald-600/15 transition">
          <svg class="w-6 h-6 text-emerald-700" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10a4 4 0 118 0 4 4 0 01-8 0z"/><path d="M4 20a8 8 0 1116 0H4z"/></svg>
        </div>
        <div class="min-w-0">
          <p class="text-[11px] tracking-wide text-slate-500 uppercase">Users</p>
          <p class="text-2xl font-bold text-slate-800">{{ kpis.users }}</p>
        </div>
      </div>
    </div>

    <div class="group bg-white/95 shadow-soft rounded-2xl p-4 border border-emerald-50 hover:border-emerald-200 transition">
      <div class="flex items-center gap-4">
        <div class="h-12 w-12 rounded-xl bg-emerald-600/10 flex items-center justify-center group-hover:bg-emerald-600/15 transition">
          <svg class="w-6 h-6 text-emerald-700" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1l8 4v6c0 5.25-3.438 10-8 12-4.562-2-8-6.75-8-12V5l8-4z"/><circle cx="12" cy="10" r="3" fill="white" opacity=".7"/></svg>
        </div>
        <div class="min-w-0">
          <p class="text-[11px] tracking-wide text-slate-500 uppercase">Admins</p>
          <p class="text-2xl font-bold text-slate-800">{{ kpis.admins }}</p>
        </div>
      </div>
    </div>

    <div class="group bg-white/95 shadow-soft rounded-2xl p-4 border border-emerald-50 hover:border-emerald-200 transition">
      <div class="flex items-center gap-4">
        <div class="h-12 w-12 rounded-xl bg-emerald-600/10 flex items-center justify-center group-hover:bg-emerald-600/15 transition">
          <svg class="w-6 h-6 text-emerald-700" viewBox="0 0 24 24" fill="currentColor"><path d="M21 8l-9-5-9 5 9 5 9-5z"/><path d="M3 10l9 5 9-5v6l-9 5-9-5v-6z" opacity=".85"/></svg>
        </div>
        <div class="min-w-0">
          <p class="text-[11px] tracking-wide text-slate-500 uppercase">Products</p>
          <p class="text-2xl font-bold text-slate-800">{{ kpis.products }}</p>
        </div>
      </div>
    </div>

    <div class="group bg-white/95 shadow-soft rounded-2xl p-4 border border-emerald-50 hover:border-emerald-200 transition">
      <div class="flex items-center gap-4">
        <div class="h-12 w-12 rounded-xl bg-emerald-600/10 flex items-center justify-center group-hover:bg-emerald-600/15 transition">
          <svg class="w-6 h-6 text-emerald-700" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18l-2 13a3 3 0 01-3 2H8a3 3 0 01-3-2L3 3z"/><circle cx="9" cy="20" r="1.5"/><circle cx="15" cy="20" r="1.5"/></svg>
        </div>
        <div class="min-w-0">
          <p class="text-[11px] tracking-wide text-slate-500 uppercase">Orders</p>
          <p class="text-2xl font-bold text-slate-800">{{ kpis.orders }}</p>
        </div>
      </div>
    </div>

    <div class="group bg-white/95 shadow-soft rounded-2xl p-4 border border-emerald-50 hover:border-emerald-200 transition">
      <div class="flex items-center gap-4">
        <div class="h-12 w-12 rounded-xl bg-emerald-600/10 flex items-center justify-center group-hover:bg-emerald-600/15 transition">
          <svg class="w-6 h-6 text-emerald-700" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c4.418 0 8 2.686 8 6s-3.582 6-8 6-8-2.686-8-6 3.582-6 8-6z"/><path d="M12 21v-6" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
        </div>
        <div class="min-w-0">
          <p class="text-[11px] tracking-wide text-slate-500 uppercase">Revenue (7d)</p>
          <p class="text-2xl font-bold text-slate-800">{{ kpis.revenue_7d|currency }}</p>
        </div>
      </div>
    </div>

    <div class="group bg-white/95 shadow-soft rounded-2xl p-4 border border-emerald-50 hover:border-emerald-200 transition">
      <div class="flex items-center gap-4">
        <div class="h-12 w-12 rounded-xl bg-emerald-600/10 flex items-center justify-center group-hover:bg-emerald-600/15 transition">
          <svg class="w-6 h-6 text-emerald-700" viewBox="0 0 24 24" fill="currentColor"><path d="M4 7h16v10a2 2 0 01-2 2H6a2 2 0 01-2-2V7z"/><path d="M4 7l8-4 8 4" opacity=".85"/></svg>
        </div>
        <div class="min-w-0">
          <p class="text-[11px] tracking-wide text-slate-500 uppercase">Revenue (All)</p>
          <p class="text-2xl font-bold text-slate-800">{{ kpis.revenue_all|currency }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-6">
    <div class="bg-white/95 shadow-soft rounded-2xl p-6 border border-slate-100">
      <h2 class="font-semibold text-slate-800 mb-3">Orders (last 7 days)</h2>
      <canvas id="ordersChart" height="120"></canvas>
    </div>
    <div class="bg-white/95 shadow-soft rounded-2xl p-6 border border-slate-100">
      <h2 class="font-semibold text-slate-800 mb-3">Revenue (last 7 days)</h2>
      <canvas id="revenueChart" height="120"></canvas>
    </div>
  </div>

  <!-- Tables -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-6">
    <div class="bg-white/95 shadow-soft rounded-2xl p-6 border border-slate-100">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold text-slate-800">Recent Orders</h2>
        <a class="text-emerald-700 hover:underline text-sm font-medium" href="{{ url_for('orders_list_admin') }}">View all</a>
      </div>
      <div class="mt-3 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-500">
            <tr>
              <th class="py-2 pr-4">Order</th>
              <th class="py-2 pr-4">Total</th>
              <th class="py-2 pr-4">Status</th>
              <th class="py-2 pr-4">Date</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {% if recent_orders and recent_orders|length > 0 %}
              {% for o in recent_orders %}
                <tr class="hover:bg-slate-50/60">
                  <td class="py-2 pr-4 font-mono text-xs">
                    <a class="underline decoration-emerald-400 underline-offset-2 hover:text-emerald-700"
                       href="{{ url_for('orders_show_admin', order_id=o._id) }}">{{ o.order_no or o._id }}</a>
                  </td>
                  <td class="py-2 pr-4">{{ (o.total or 0)|currency }}</td>
                  <td class="py-2 pr-4">{{ (o.status)|status_chip | safe }}</td>
                  <td class="py-2 pr-4">{{ (o.created_at)|dt }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="4" class="py-4 text-slate-500">No orders yet.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="bg-white/95 shadow-soft rounded-2xl p-6 border border-slate-100">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold text-slate-800">Low Stock</h2>
        <a class="text-emerald-700 hover:underline text-sm font-medium" href="{{ url_for('products_list_admin') }}">Manage products</a>
      </div>
      <div class="mt-3 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-500">
            <tr>
              <th class="py-2 pr-4">Product</th>
              <th class="py-2 pr-4">SKU</th>
              <th class="py-2 pr-4">Stock</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {% if low_stock and low_stock|length > 0 %}
              {% for p in low_stock %}
                <tr class="hover:bg-slate-50/60">
                  <td class="py-2 pr-4">{{ p.name or 'Untitled' }}</td>
                  <td class="py-2 pr-4">{{ p.sku or '-' }}</td>
                  <td class="py-2 pr-4">{{ p.stock if p.stock is not none else 0 }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="3" class="py-4 text-slate-500">No low-stock items.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>  {# /full-bleed #}

<!-- Charts UI only (data untouched) -->
<script>
  const labels = {{ chart.labels|tojson }};
  const orders = {{ chart.orders|tojson }};
  const revenue = {{ chart.revenue|tojson }};

  Chart.defaults.font.family = 'Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
  Chart.defaults.color = '#64748b';
  Chart.defaults.plugins.legend.display = false;
  Chart.defaults.scale.grid.color = 'rgba(100,116,139,0.08)';

  // Orders Bar
  new Chart(document.getElementById('ordersChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Orders',
        data: orders,
        borderRadius: 8,
        backgroundColor: 'rgba(16,185,129,0.35)',
        hoverBackgroundColor: 'rgba(16,185,129,0.55)',
        borderColor: 'rgba(16,185,129,0.9)',
        borderWidth: 1
      }]
    },
    options: {
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    }
  });

  // Revenue Line + gradient fill
  const revCtx = document.getElementById('revenueChart').getContext('2d');
  const grad = revCtx.createLinearGradient(0, 0, 0, 220);
  grad.addColorStop(0, 'rgba(16,185,129,0.35)');
  grad.addColorStop(1, 'rgba(16,185,129,0.04)');

  new Chart(revCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Revenue',
        data: revenue,
        fill: true,
        tension: 0.35,
        backgroundColor: grad,
        borderColor: 'rgba(5,150,105,1)',
        pointRadius: 3,
        pointHoverRadius: 4
      }]
    },
    options: {
      scales: { y: { beginAtZero: true } }
    }
  });
</script>
{% endblock %}
