{% extends "base.html" %}
{% block title %}Edit Product â€” {{ p.name }}{% endblock %}
{% block content %}
  <form method="post" action="{{ url_for('products_update_admin', product_id=p._id) }}" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="bg-white/90 shadow-soft rounded-2xl p-6 space-y-6">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">Edit Product</h1>
        <div class="space-x-2">
          <a href="{{ url_for('products_list_admin') }}" class="underline text-purple-700">Back</a>
          <button class="px-4 py-2 rounded-xl bg-purple-600 text-white">Save</button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm mb-1">Name</label><input name="name" class="w-full px-4 py-3 rounded-xl bg-gray-100" value="{{ p.name }}" required></div>
        <div><label class="block text-sm mb-1">Brand</label><input name="brand" class="w-full px-4 py-3 rounded-xl bg-gray-100" value="{{ p.brand }}" required></div>

        <div>
          <label class="block text-sm mb-1">Category</label>
          <select name="category_id" id="category_id" class="w-full px-4 py-3 rounded-xl bg-gray-100" required onchange="updateItemTypes()">
            <option value="">Select category</option>
            {% for c in categories %}
              <option value="{{ c._id }}" data-types="{{ (c.item_types or [])|join('||') }}" {% if p.category_id==c._id|string %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">Item Type</label>
          <select name="item_type" id="item_type" class="w-full px-4 py-3 rounded-xl bg-gray-100" required>
            <option value="{{ p.item_type }}">{{ p.item_type }}</option>
          </select>
        </div>

        <div><label class="block text-sm mb-1">SKU</label><input name="sku" class="w-full px-4 py-3 rounded-xl bg-gray-100" value="{{ p.sku }}" required></div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-sm mb-1">Price</label><input name="price" type="number" step="0.01" class="w-full px-4 py-3 rounded-xl bg-gray-100" value="{{ p.price or 0 }}"></div>
          <div><label class="block text-sm mb-1">Currency</label><input name="currency" class="w-full px-4 py-3 rounded-xl bg-gray-100" value="{{ p.currency or 'LKR' }}"></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-sm mb-1">Stock</label><input name="stock" type="number" class="w-full px-4 py-3 rounded-xl bg-gray-100" value="{{ p.stock or 0 }}"></div>
          <div>
            <label class="block text-sm mb-1">Status</label>
            <select name="status" class="w-full px-4 py-3 rounded-xl bg-gray-100">
              <option value="draft" {% if p.status=='draft' %}selected{% endif %}>Draft</option>
              <option value="published" {% if p.status=='published' %}selected{% endif %}>Published</option>
              <option value="archived" {% if p.status=='archived' %}selected{% endif %}>Archived</option>
            </select>
          </div>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Short Description</label>
          <input name="short_description" class="w-full px-4 py-3 rounded-xl bg-gray-100" value="{{ p.short_description }}">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Description (HTML allowed)</label>
          <textarea name="description_html" rows="6" class="w-full px-4 py-3 rounded-xl bg-gray-100">{{ p.description_html }}</textarea>
        </div>

        <div><label class="block text-sm mb-1">Size/Volume</label><input name="size_volume" class="w-full px-4 py-3 rounded-xl bg-gray-100" value="{{ p.size_volume }}"></div>
        <div><label class="block text-sm mb-1">Country of Origin</label><input name="country_of_origin" class="w-full px-4 py-3 rounded-xl bg-gray-100" value="{{ p.country_of_origin }}"></div>

        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Tags (comma separated)</label>
          <input name="tags" class="w-full px-4 py-3 rounded-xl bg-gray-100" value="{{ (p.tags or [])|join(', ') }}">
        </div>

        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p class="font-medium mb-2">Skin Types</p>
            <div class="grid grid-cols-2 gap-2">
              {% for s in attributes.skin_types %}
                <label class="inline-flex items-center gap-2">
                  <input type="checkbox" name="skin_types" value="{{ s.key }}" class="h-4 w-4" {% if s.key in (p.skin_types or []) %}checked{% endif %}>
                  <span class="text-sm">{{ s.label }}</span>
                </label>
              {% endfor %}
            </div>
          </div>
          <div>
            <p class="font-medium mb-2">Concerns</p>
            <div class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto pe-2">
              {% for c in attributes.concerns %}
                <label class="inline-flex items-center gap-2">
                  <input type="checkbox" name="concerns" value="{{ c.key }}" class="h-4 w-4" {% if c.key in (p.concerns or []) %}checked{% endif %}>
                  <span class="text-sm">{{ c.label }}</span>
                </label>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Hero Image</label>
            {% if p.hero_image %}<img src="{{ p.hero_image }}" class="w-40 rounded-lg shadow mb-2">{% endif %}
            <input type="file" name="hero_image" accept="image/*" class="w-full px-4 py-2 rounded-xl bg-gray-100">
          </div>
          <div>
            <label class="block text-sm mb-1">Gallery Images</label>
            <div class="flex gap-2 flex-wrap mb-2">
              {% for g in p.gallery or [] %}
                <img src="{{ g }}" class="w-20 h-20 object-cover rounded-lg shadow">
              {% endfor %}
            </div>
            <input type="file" name="gallery" multiple accept="image/*" class="w-full px-4 py-2 rounded-xl bg-gray-100">
            <label class="inline-flex items-center gap-2 mt-2"><input type="checkbox" name="clear_gallery" class="h-4 w-4"><span class="text-sm">Replace gallery (clear existing)</span></label>
          </div>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Alt Text (for images)</label>
          <input name="alt_text" class="w-full px-4 py-3 rounded-xl bg-gray-100" value="{{ p.alt_text }}">
        </div>
      </div>
    </div>
  </form>
  <script>
    function updateItemTypes() {
      const sel = document.getElementById('category_id');
      const typesStr = sel.options[sel.selectedIndex]?.getAttribute('data-types') || '';
      const types = typesStr ? typesStr.split('||') : [];
      const typeSel = document.getElementById('item_type');
      const current = "{{ p.item_type|e }}";
      typeSel.innerHTML = '<option value="">Select item type</option>' + types.map(t => `<option ${t===current?'selected':''} value="${t}">${t}</option>`).join('');
    }
    updateItemTypes();
  </script>
{% endblock %}
